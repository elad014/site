version: '3.8'
services:
  web_app:
    # Description: Main Flask web application with login, signup, manager, and stock pages
    container_name: web_app
    build:
      context: .
      dockerfile: app/Dockerfile
    ports:
      - "8080:8080"
    env_file:
      - .env
    restart: unless-stopped
    networks:
      - app_network

  stock_data_collector:
    # Description: Stock data API service that fetches data from Alpha Vantage
    container_name: stock_data_collector
    build:
      context: .
      dockerfile: stocks_data_collector/Dockerfile
    ports:
      - "5001:5001"
    env_file:
      - .env
    restart: unless-stopped
    networks:
      - app_network

  scheduler:
    # Description: Background scheduler that periodically updates stock data
    container_name: scheduler
    build:
      context: .
      dockerfile: schedualer/Dockerfile
    env_file:
      - .env
    restart: unless-stopped
    depends_on:
      - stock_data_collector
    environment:
      - Stock_Data_Collector_Service_URL=http://localhost:5001
    networks:
      - app_network
  # ollama_flask_server:
  #   build:
  #     context: ./ollama_services
  #     dockerfile: Dockerfile
  #   #image: eladnatan/stocks_beta:ollma_flask_server
  #   container_name: flask-app
  #   ports:
  #     - "5003:5003"
  #   depends_on:
  #     - ollama
  #   environment:
  #     - OLLAMA_HOST=http://ollama:11435
  #   restart: unless-stopped
  #   networks:
  #     - app_network

  ollama:
    image: eladnatan/ollama:l3
    container_name: ollama
    ports:
      - "11435:11434"
    restart: unless-stopped
    networks:
      - app_network

  rag_service:
    # Description: RAG service for PDF document indexing and semantic search with LLM
    container_name: rag_service
    build:
      context: ./rag
      dockerfile: Dockerfile
    ports:
      - "5002:5002"
    env_file:
      - .env
    environment:
      - RAG_PORT=5002
      - OLLAMA_URL=http://ollama:11434
      - OLLAMA_MODEL=llama3
      - TRANSFORMERS_CACHE=/app/.cache
      - SENTENCE_TRANSFORMERS_HOME=/app/.cache
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    volumes:
      - rag_models:/app/.cache
      - ./pdf_storage:/app/pdf_storage
    depends_on:
      - ollama
      - kafka
    restart: unless-stopped
    networks:
      - app_network

  zookeeper:
    # Description: Zookeeper for Kafka coordination
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    restart: unless-stopped
    networks:
      - app_network

  kafka:
    # Description: Kafka message broker for chat monitoring
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
      - "9093:9093"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:9093
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    restart: unless-stopped
    networks:
      - app_network

  kafka_consumer:
    # Description: Kafka consumer service that writes chat history to PostgreSQL
    container_name: kafka_consumer
    build:
      context: ./kafka_consumer
      dockerfile: Dockerfile
    env_file:
      - .env
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - KAFKA_TOPIC=chat_messages
      - KAFKA_GROUP_ID=chat_history_consumer
    depends_on:
      - kafka
    restart: unless-stopped
    networks:
      - app_network

networks:
  app_network:
    driver: bridge

volumes:
  ollama_data:
  rag_models:
  # pdf_storage:  # Now using bind mount ./pdf_storage instead

